<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'>
<title>
ilkka.github.com
 - Packaging a Qt app for OS X
</title>
<link href='http://fonts.googleapis.com/css?family=Cantarell:regular,italic,bold,bolditalic&amp;subset=latin' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Vollkorn:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css'>
<link href='/css/default.css' media='screen' rel='stylesheet' type='text/css'>
<link href='/css/pygments/default.css' media='screen' rel='stylesheet' type='text/css'>
<link href='http://feeds.feedburner.com/ilkkagithubcom' rel='alternate' type='application/atom+xml'>
<meta content='nanoc 3' name='generator'>
<script>
  //<![CDATA[
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-3223507-4']);
    _gaq.push(['_trackPageview']);
    
    (function() {
     var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
     ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
     var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
     })();
  //]]>
</script>
</head>
<body>
<div id='main-container'>
<div class='feed-icon-floater'>
<a href='http://ilkka.github.com/atom.xml'>
<img alt='Atom feed' src='/images/feed-icon-28x28.png'>
</a>

</div>
<div class='centered-container'>
<div id='header'>
<h1>
Packaging a Qt app for OS X
</h1>
</div>
<div id='content'>
<div class='post'>
<div class='postbody'>
<p>I participated in <a href="http://barcamp.org/w/page/39167337/BarCampTampere2">BarCamp Tampere
2</a> recently, and one of
the many very interesting presentations was <a href="http://www.modeemi.fi/~cosmo">Ville
Ranki</a> talking about
<a href="http://siilihai.com/">Siilihai</a>, a web forum reader app intentionally very
reminiscent of newsreaders of old. Siilihai scrapes the content from web
forums and presents it as threaded conversations so that it’s easier to read
and follow conversations. Parsers can be written pretty easily for
most forum software, and while forum content is only accessed locally by the
client, it stores generated message IDs in the siilihai.com service so that
whatever messages you read in one client are marked read in any other clients
you might use as well. The service is also used as a repository for forum
parsers.</p>

<p>Anyway, as the event was held at <a href="http://www.futurice.com">our office</a>, I
grabbed a Mac that was handy so that I could try out Siilihai for myself.
Getting it built was simple as it is written using Qt, but I wanted to create
a distributable package (an app bundle in OS X parlance) so that all the other
beret wearers could enjoy it too. This, however, turned out to be a bit more
involved than I’d thought.</p>

<h2 id="the-anatomy-of-an-app">The anatomy of an app</h2>

<p>An app bundle is pretty self-contained. Apart from basic system libraries that
can be assumed to be available on every Mac, apps usually ship all their
libraries inside the app bundle together with the runnable binary. Some space
may be wasted this way if several apps bundle the same libraries, but
generally it seems pretty useful. At least it’s simple to deploy applications
when they can simply be copied into place.</p>

<p>Siilihai uses a couple of shared libraries of its own, and naturally Qt. Since
Qt is not installed by default in OS X, I had to include all of these in the
app bundle. Bundling Qt is relatively simple using the
<a href="http://doc.qt.nokia.com/stable/deployment-mac.html">macdeployqt</a> tool
included in the Qt SDK, but it only really takes care of the whole process if
the application is a single binary that is only dependent on Qt. Siilihai’s
custom libraries required a bit more love.</p>

<h2 id="rewiring-and-rewriting">Rewiring and rewriting</h2>

<p>For an app that uses dynamic libraries to work, the runtime linker must be
able to find the libraries when the app is run. In Unix-style OSes this is
generally accomplished by installing the libraries into standard paths such as
<code>/usr/lib</code>. The dynamic linker is preconfigured to look in these directories
when it is looking for library files.</p>

<p>If the libraries are for some reason installed into a nonstandard path, that
path can also be configured as an “rpath” in the app binary itself. This is
just another way of telling the dynamic linker where to look, but in a per-app
fashion.</p>

<p>These concepts are valid for OS X <code>.dylib</code> files as well, with some
differences. Using the command line utility <code>otool</code> we can examine this
search path information. Let’s see the output for <code>otool</code> itself:</p>

<pre><code class="language-bash">$ otool -L `which otool`
/usr/bin/otool:
        /usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current
        version 159.0.0)</code></pre>

<p>We can see that otool depends on a single dylib, libSystem. Now, my knowledge
isn’t broad enough to tell if the actual path to the lib is hardcoded in the
binary, or if the output is due to the dynamic linker knowing to look in
<code>/usr/lib</code>, but in the context of this discussion it doesn’t really matter.
Let’s look at the output for <code>libSystem.B.dylib</code> next:</p>

<pre><code class="language-bash">$ otool -L /usr/lib/libSystem.B.dylib
/usr/lib/libSystem.B.dylib:
        /usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current
        version 159.0.0)
        /usr/lib/system/libcache.dylib (compatibility version 1.0.0, current
        version 47.0.0)
        /usr/lib/system/libcommonCrypto.dylib (compatibility version 1.0.0,
        current version 55010.0.0)
        /usr/lib/system/libcompiler_rt.dylib (compatibility version 1.0.0,
        current version 6.0.0)
        /usr/lib/system/libcopyfile.dylib (compatibility version 1.0.0,
        current version 85.1.0)
        ...</code></pre>

<p>We see that libSystem is linked against a whole bunch of other system
libraries, but also that the otool output lists the library itself. As far as
I can tell, this is because the library knows its own path, something that
needs to be taken into account later. If you know better, please leave a
comment.</p>

<p>The consequence is that because I was going to put siilihai’s libraries in a
nonstandard place (inside the app bundle), I need to edit the library
locations stored in the app binary so that the libraries get found by the
linker. Siilihai’s libraries also link to each other, so I have to do the same
thing to them too.</p>

<p>If this all sounds complicated, that is because it is. In software it soon
pays to automate even the simplest of tasks, and here there is definitely a
lot to gain, so I wrote a script to build Siilihai and perform all these
magic tricks for me.</p>

<h2 id="scripture">Scripture</h2>

<p>You can see the whole <a href="https://github.com/ilkka/siilihai-client/blob/osx/scripts/build-osx.sh">script in
github</a>,
but I’ll explain the most relevant bits here.</p>

<p>First, the script tries to be clever about allowing you to run it from
whatever directory and still finding all the sources and whatnot. For this it
first locates the script directory:</p>

<pre><code class="language-bash">SCRIPT=$(python -c 'import os,sys;print os.path.realpath(sys.argv[1])' $0)
SCRIPTDIR=$(dirname $SCRIPT)</code></pre>

<p>Using GNU readlink, the first assignment would be the much simpler
<code>SCRIPT=$(readlink -f $0)</code>, but it doesn’t, hence the Python. Anyway, now that
the script knows where it is, by extension it also knows where the Siilihai
client source is. It assumes that
<a href="https://github.com/vranki/libsiilihai">libsiilihai</a>’s sources are in the same
directory.</p>

<p>The script creates a temporary directory and proceeds to do normal shadow
builds of the lib and the client. The lib build generates exclusively .dylib
files while the client generates both .dylibs and an app bundle. The next step
is to copy all the .dylibs into the app bundle. It doesn’t really matter
where, but I decided to put them in the <code>/Contents/Frameworks</code> directory since
I happen to know that’s where the Qt libs will end up too.</p>

<pre><code class="language-bash">status "Copying libsiilihai dylibs into client bundle"
BUNDLEDIR=$CLIENTBUILDDIR/src/reader/siilihai.app
FWKDIR=$BUNDLEDIR/Contents/Frameworks
mkdir -p "$FWKDIR"
for LIB in "$LIBBUILDDIR"/src/*.dylib "$CLIENTBUILDDIR"/src/common/*.dylib \
        "$CLIENTBUILDDIR"/src/parsermaker/*.dylib; do
        cp -a "$LIB" "$FWKDIR"</code></pre>
<!-- a* -->

<p>Now we use
<a href="http://www.manpagez.com/man/1/install_name_tool/"><code>install_name_tool</code></a> to set
the ID of each library after it is copied:</p>

<pre><code class="language-bash">LIBBASENAME=$(basename $LIB)
        LIB=$FWKDIR/$LIBBASENAME
        install_name_tool -id "@executable_path/../Frameworks/$LIBBASENAME" \
                "$LIB"</code></pre>

<p>We set the ID to be the relative path inside the app bundle from the
executable binary (which resides in <code>/Contents/MacOSX</code>) to the library. This
is the same rpath that will be set in the executable later.</p>

<p>Since all the Siilihai libraries are linked against Qt, and the Qt frameworks
will be deployed into the app bundle too, we need to change their rpaths in
the libraries. At this point they still point at e.g. the Qt SDK used to build
the libs. We grep the framework names from otool output, generate new paths
for them and change the paths in the libs:</p>

<pre><code class="language-bash">QTDEPS=$(otool -L $LIB|egrep 'Qt.*\.framework'| \
                egrep -v '@executable_path'|awk '{print $1}'|tr '\n' ' ')
        for DEP in $(echo $QTDEPS); do
                NEWDEP=$(echo $DEP|sed 's%.*gcc/lib/%%')
                install_name_tool -change "$DEP" \
                        "@executable_path/../Frameworks/$NEWDEP" "$LIB"
        done</code></pre>

<p>Note that we ignore any Qt frameworks that might already have working paths
with the <code>egrep -v '@executable_path'</code> bit. Now when the Qt frameworks get
copied into <code>/Contents/Frameworks</code>, the Siilihai libs will get linked against
them at runtime. The libs are dependent on each other too, though, so we need
another round of dependency path fixing, this time picking anything with
<code>libsiilihai</code> in the name:</p>

<pre><code class="language-bash">DEPS=$(otool -L $LIB|egrep 'libsiilihai'|egrep -v '@executable_path' \
                |awk '{print $1}'|tr '\n' ' ')
        for DEP in $(echo $DEPS); do
                install_name_tool -change "$DEP" \
                        "@executable_path/../Frameworks/$DEP" "$LIB"
        done
done</code></pre>

<p>That concludes the library ID and path fixing loop. Now the only thing
remaining is to run the <code>macdeployqt</code> tool. This tool finds all the Qt
frameworks the executable is linked against and copies them into the bundle.
It also strips them and fixes all the IDs and rpaths. As an additional bonus,
since we’ve already copied Siilihai’s own .dylibs into the bundle, it also
fixes <em>their</em> paths in the executable. The result is a self-contained app
bundle that can be run in any reasonably modern Mac. Currently I believe the
bundle is compatible with Intel Macs running OS X 10.5 or later.</p>

<h2 id="further-development">Further development</h2>

<p>One rather major problem with the script so far is that it leaves the app
bundle using the default app icon, while it should use the Siilihai icon from
the repo. This is something I’ll have to find out how to do. Other than that,
the only thing I’ve thought of is support for tagging the repos when
successful builds are made, and settings some sort of version metadata, should
bundles support something like that.</p>

<p>The experience does leave me with the feeling that if I was to write an app
that I wanted to deploy onto Macs, I would just link everything into a
monolithic binary. Given today’s storage space yadda yadda etc., you get the
point.</p>
</div>
<div class='postfooter'>
Posted on Wednesday 19 October 2011 and tagged <a href="/tag/qt/">qt</a> and <a href="/tag/osx/">osx</a>.

</div>
</div>
<div class='navlinks'>
<div class='previous' style='float: left'>
Previously:&nbsp;<a href="/blog/2011/05/25/dgh-the-debian-ubuntu-downgrade-helper/">Dgh, The Debian/Ubuntu Downgrade Helper</a>
</div>

</div>
<br style='break: both'>
<div class='related'>
<h3>More stuff like this</h3>
<ul>
<li>
<a href="/blog/2010/11/20/hosting-a-jekyll-blog-with-extensions-on-github/">Hosting a Jekyll blog with extensions on Github</a>
(2010-11-20)
</li>
<li>
<a href="/blog/2011/02/27/migrating_a_live_ubuntu_install_onto_lvm2/">Migrating a live Ubuntu install onto LVM2</a>
(2011-02-27)
</li>
<li>
<a href="/blog/2011/03/04/qtquick_2_scenegraph_glsl_fragment_shader_tutorial/">Qt Quick 2 QML Scene Graph GLSL fragment shader tutorial</a>
(2011-03-04)
</li>
</ul>

</div>
<div class='comments'>
<h3>Comments</h3>
<!-- begin disqus comment code -->
<div id="disqus_thread"></div>
<script type="text/javascript">
  /**
  * var disqus_identifier; [Optional but recommended: Define a
  unique identifier (e.g. post id or slug) for this thread] 
  */
  (function() {
  var dsq = document.createElement('script'); dsq.type =
  'text/javascript'; dsq.async = true;
  dsq.src = 'http://ilkkablog.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] ||
  document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view
  the <a href="http://disqus.com/?ref_noscript=ilkkablog">comments
    powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered
  by <span class="logo-disqus">Disqus</span></a>
<!-- end disqus comment code -->

<!-- begin disqus comment count code -->
<script type="text/javascript">
  var disqus_shortname = 'ilkkablog';
  (function () {
  var s = document.createElement('script'); s.async = true;
  s.src = 'http://disqus.com/forums/ilkkablog/count.js';
  (document.getElementsByTagName('HEAD')[0] ||
  document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
</script>
<!-- end disqus comment count code -->

</div>
</div>
</div>
</div>
<div id='footer-container'>
<div id='footer'>
<div class='col'>
<h3>What else is here?</h3>
<ul>
<li>
<a href='/'>Front page</a>
</li>
<li>
Archives
<ul>
<li><a href="/archives/2010/11/">2010/11</a></li>
<li><a href="/archives/2010/12/">2010/12</a></li>
<li><a href="/archives/2011/01/">2011/1</a></li>
<li><a href="/archives/2011/02/">2011/2</a></li>
<li><a href="/archives/2011/03/">2011/3</a></li>
<li><a href="/archives/2011/05/">2011/5</a></li>
<li><a href="/archives/2011/10/">2011/10</a></li>
</ul>
</li>
</ul>

</div>
<div class='col'>
<h3>Tags</h3>
<ul class='tagcloud'>
<li style='font-size: 70.98373692144486%'>
<a href="/tag/meta/">meta</a>
</li>
<li style='font-size: 149.69506197546147%'>
<a href="/tag/ruby/">ruby</a>
</li>
<li style='font-size: 70.98373692144486%'>
<a href="/tag/jekyll/">jekyll</a>
</li>
<li style='font-size: 193.80930871145782%'>
<a href="/tag/coding/">coding</a>
</li>
<li style='font-size: 63.65616841209596%'>
<a href="/tag/qt/">qt</a>
</li>
<li style='font-size: 63.65616841209596%'>
<a href="/tag/qml/">qml</a>
</li>
<li style='font-size: 87.01563350411524%'>
<a href="/tag/ubuntu/">ubuntu</a>
</li>
<li style='font-size: 60.99642213298283%'>
<a href="/tag/rake/">rake</a>
</li>
<li style='font-size: 60.99642213298283%'>
<a href="/tag/photography/">photography</a>
</li>
<li style='font-size: 60.99642213298283%'>
<a href="/tag/tools/">tools</a>
</li>
<li style='font-size: 60.99642213298283%'>
<a href="/tag/vim/">vim</a>
</li>
<li style='font-size: 60.99642213298283%'>
<a href="/tag/jitsu/">jitsu</a>
</li>
<li style='font-size: 60.99642213298283%'>
<a href="/tag/ninja/">ninja</a>
</li>
<li style='font-size: 60.99642213298283%'>
<a href="/tag/maemo/">maemo</a>
</li>
<li style='font-size: 60.99642213298283%'>
<a href="/tag/n900/">n900</a>
</li>
<li style='font-size: 60.99642213298283%'>
<a href="/tag/qtquick/">qtquick</a>
</li>
<li style='font-size: 60.99642213298283%'>
<a href="/tag/glsl/">glsl</a>
</li>
<li style='font-size: 60.99642213298283%'>
<a href="/tag/scenegraph/">scenegraph</a>
</li>
<li style='font-size: 60.99642213298283%'>
<a href="/tag/opengl/">opengl</a>
</li>
<li style='font-size: 60.99642213298283%'>
<a href="/tag/sysadmin/">sysadmin</a>
</li>
<li style='font-size: 60.99642213298283%'>
<a href="/tag/osx/">osx</a>
</li>
</ul>

</div>
<div class='col'>
<h3>Find me elsewhere</h3>
<ul style='list-style-type: none'>
<li>
<a href='http://twitter.com/ilkkalaukkanen'>
<img alt='twitter.com/ilkkalaukkanen' src='/images/follow_bird_me-a.png'>
</a>
</li>
<li>
<a href='http://goo.gl/LSptt'>google plus</a>
</li>
<li>
<a href='https://github.com/ilkka'>github.com/ilkka</a>
</li>
<li>
<a href='https://bitbucket.org/Ilkka'>bitbucket.org/Ilkka</a>
</li>
</ul>

</div>
<div id='credits'>
<p>This site was generated by <a href='http://nanoc.stoneship.org'>Nanoc</a>. Fonts courtesy of <a href='http://code.google.com/webfonts'>Google Font Directory</a>.</p>
</div>
</div>
</div>
</body>
</html>
